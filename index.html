<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplies Monitoring System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root { 
            --primary: #2c3e50; 
            --secondary: #34495e; 
            --accent: #4a90e2; 
            --success: #27ae60;
            --danger: #e74c3c;
            --bg: #f0f2f5; 
            --white: #ffffff; 
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: #333; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 260px; 
            background: linear-gradient(180deg, #1a252f 0%, #2c3e50 100%); 
            color: var(--white); 
            display: flex; flex-direction: column; 
            padding: 25px; 
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .sidebar h2 { 
            text-align: center; 
            font-size: 1.5rem; 
            margin-bottom: 40px; 
            letter-spacing: 1px; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 20px;
        }
        .nav-link { 
            padding: 15px 20px; 
            cursor: pointer; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            transition: all 0.3s ease; 
            display: flex; align-items: center; gap: 12px;
            font-weight: 500;
            color: #bdc3c7;
        }
        .nav-link i { width: 20px; text-align: center; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; transform: translateX(5px); }
        .nav-link.active { background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4); }

        /* --- MAIN LAYOUT --- */
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD STYLES --- */
        .dashboard-header { margin-bottom: 30px; }
        .dashboard-header h1 { margin: 0; font-size: 2rem; color: var(--primary); }
        .dashboard-header p { color: #7f8c8d; margin-top: 5px; }

        /* Stats Cards */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { 
            background: white; padding: 25px; border-radius: 16px; 
            box-shadow: var(--shadow); position: relative; overflow: hidden; 
            transition: transform 0.3s ease;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .card .number { font-size: 2.8rem; font-weight: 700; color: var(--primary); }
        .card .icon-bg { 
            position: absolute; right: -20px; bottom: -20px; 
            font-size: 8rem; opacity: 0.05; transform: rotate(-15deg); 
        }
        
        /* Card Colors */
        .card.blue { border-left: 5px solid var(--accent); }
        .card.orange { border-left: 5px solid #e67e22; }

        /* Dashboard Grid Layout (Chart + Actions) */
        .dashboard-content { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        @media (max-width: 1000px) { .dashboard-content { grid-template-columns: 1fr; } }

        .panel { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow); }
        .panel h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 15px; color: var(--primary); font-size: 1.1rem; }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed #cbd5e0; border-radius: 12px;
            padding: 30px 20px; text-align: center;
            cursor: pointer; transition: 0.3s;
            background: #f8fafc;
        }
        .upload-zone:hover { border-color: var(--accent); background: #ebf8ff; }
        .upload-zone i { font-size: 2rem; color: #a0aec0; margin-bottom: 10px; }
        .upload-zone p { margin: 0; color: #718096; font-size: 0.9rem; }
        input[type="file"] { display: none; }

        /* Admin Button */
        .btn-reset { 
            width: 100%; background: #fff5f5; color: var(--danger); 
            border: 1px solid #feb2b2; padding: 15px; border-radius: 8px; 
            cursor: pointer; font-weight: bold; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
        }
        .btn-reset:hover { background: var(--danger); color: white; border-color: var(--danger); }

        /* --- INVENTORY TABLE --- */
        table.inventory-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        table.inventory-table th { background: var(--secondary); color: white; padding: 15px; text-align: left; font-weight: 600; }
        table.inventory-table td { padding: 15px; border-bottom: 1px solid #f0f0f0; color: #555; vertical-align: middle; }
        table.inventory-table tr:hover { background: #f9f9f9; }
        
        /* Floating Action Button */
        .btn-req { 
            position: fixed; bottom: 40px; right: 40px; 
            background: linear-gradient(135deg, #4a90e2, #357abd); 
            color: white; padding: 15px 35px; border-radius: 50px; 
            border: none; font-size: 1rem; font-weight: bold; 
            cursor: pointer; box-shadow: 0 10px 20px rgba(74, 144, 226, 0.4); 
            z-index: 10; transition: transform 0.2s;
        }
        .btn-req:hover { transform: translateY(-3px); }

        /* --- MODAL & FORMS (Existing) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(2px);
            display: none; justify-content: center; overflow-y: auto; 
            z-index: 2000; padding: 20px 0;
        }
        .modal-overlay.open { display: flex; }
        .modal-actions { 
            position: fixed; top: 20px; right: 20px; 
            display: flex; flex-direction: column; gap: 10px; 
            z-index: 3000; background: white; padding: 15px; 
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; width: 160px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-close { background: var(--danger); }
        .btn-print { background: var(--success); }
        .btn-excel { background: #217346; }
        .btn-submit { background: var(--accent); }

        /* --- PAPER SLIP (A4) --- */
        .paper-slip {
            width: 210mm; min-height: 297mm; background: white;
            padding: 5mm 10mm; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            font-family: 'Arial Narrow', Arial, sans-serif; color: black;
            font-size: 10px; box-sizing: border-box; position: relative; margin-top: 20px;
        }
        /* Official RIS CSS (Keep Exact) */
        .ris-container { margin-bottom: 10px; }
        .cut-line { border-top: 1px dashed black; margin: 15px 0; position: relative; }
        .cut-line::after { content: "✂"; position: absolute; right: 50%; top: -10px; background: white; padding: 0 5px; font-size: 14px;}
        .ris-header-italic { text-align: right; font-style: italic; font-size: 9px; margin-bottom: 2px; font-weight: bold; }
        .ris-title { text-align: center; font-weight: bold; font-size: 14px; margin: 5px 0 10px 0; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        .info-table td { padding: 1px; vertical-align: bottom; }
        .label { font-weight: bold; white-space: nowrap; font-size: 10px; }
        .input-line { border-bottom: 1px solid black; text-align: center; font-weight: bold; display: block; width: 100%; min-height: 14px;}
        table.ris-table { width: 100%; border-collapse: collapse; border: 2px solid black; table-layout: fixed; }
        table.ris-table th, table.ris-table td { border: 1px solid black; padding: 2px; text-align: center; vertical-align: middle; word-wrap: break-word; font-size: 10px; }
        table.ris-table th { font-weight: bold; background: #eee; }
        .empty-row td { height: 14px; }
        table.footer-table { width: 100%; border-collapse: collapse; border: 2px solid black; border-top: none; table-layout: fixed; margin-top: -2px;}
        table.footer-table td { border-right: 1px solid black; padding: 2px; vertical-align: top; font-size: 10px; }
        table.footer-table tr:first-child td { border-bottom: none; font-weight: bold; }
        table.footer-table tr td:first-child { width: 100px; font-weight: bold; text-align: left;}
        .sig-name { text-align: center; font-weight: bold; text-transform: uppercase; margin-top: 10px; font-size: 11px;}
        .sig-title { text-align: center; font-size: 9px; }

        /* Add Item Controls */
        .add-item-controls {
            background: white; padding: 15px 25px; border-radius: 50px;
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 2100;
            display: flex; gap: 15px; align-items: center; border: 1px solid #eee;
        }

        /* --- PRINT SETTINGS --- */
        @media print {
            @page { margin: 0; }
            body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            body * { visibility: hidden; }
            .modal-overlay { 
                position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                background: white; display: block !important; padding: 0; overflow: visible; z-index: 9999;
            }
            .paper-slip, .paper-slip * { visibility: visible; }
            .paper-slip { 
                transform: scale(1); width: 100%; margin: 0; padding: 10mm; 
                position: absolute; top: 0; left: 0; box-shadow: none; 
            }
            .modal-actions, .add-item-controls { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2><i class="fa-solid fa-boxes-stacked"></i> IMS System</h2>
        <div class="nav-link active" onclick="nav('dashboard', this)">
            <i class="fa-solid fa-chart-line"></i> Dashboard
        </div>
        <div class="nav-link" onclick="nav('inventory', this)">
            <i class="fa-solid fa-list-check"></i> Inventory List
        </div>
    </div>

    <div class="main">
        <div id="dashboard" class="section active">
            <div class="dashboard-header">
                <h1>Overview</h1>
                <p>Welcome back, Admin. Here's what's happening with your inventory.</p>
            </div>

            <div class="cards-grid">
                <div class="card blue">
                    <h3>Total Items in Stock</h3>
                    <div class="number" id="dash-total-items">0</div>
                    <i class="fa-solid fa-cubes icon-bg"></i>
                </div>
                <div class="card orange">
                    <h3>Total Requisitions</h3>
                    <div class="number" id="dash-total-reqs">0</div>
                    <i class="fa-solid fa-file-invoice icon-bg"></i>
                </div>
            </div>
            
            <div class="dashboard-content">
                <div class="panel">
                    <h3><i class="fa-solid fa-chart-simple"></i> Stock Levels</h3>
                    <div style="height: 300px;"><canvas id="stockChart"></canvas></div>
                </div>

                <div class="panel">
                    <h3><i class="fa-solid fa-sliders"></i> Quick Actions</h3>
                    
                    <div style="margin-bottom: 25px;">
                        <label for="fileInput" class="upload-zone">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <p><strong>Click to Upload Excel</strong><br>Format: Name, Qty, Price</p>
                        </label>
                        <input type="file" id="fileInput" onchange="handleFileUpload(this)" accept=".xlsx, .csv" />
                    </div>

                    <button class="btn-reset" onclick="resetInventory()">
                        <i class="fa-solid fa-triangle-exclamation"></i> 
                        Reset System Data
                    </button>
                    <p style="font-size: 0.8rem; color: #999; text-align: center; margin-top: 10px;">
                        Resets stocks to initial & clears history.
                    </p>
                </div>
            </div>
        </div>

        <div id="inventory" class="section">
            <div class="dashboard-header">
                <h1>Inventory List</h1>
                <p>Manage your stock details, add supplies, and request items.</p>
            </div>
            <table class="inventory-table">
                <thead><tr><th>Item Name</th><th>Init Qty</th><th>Unit Price</th><th>Current Stock</th><th>Add Supplies</th></tr></thead>
                <tbody id="inventoryTable"></tbody>
            </table>
            <button class="btn-req" onclick="openModal()">
                <i class="fa-solid fa-plus"></i> Request Supplies
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="reqModal">
        
        <div class="modal-actions">
            <button class="btn btn-close" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Close</button>
            <button class="btn btn-print" onclick="window.print()"><i class="fa-solid fa-print"></i> Print RIS</button>
            <button class="btn btn-excel" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
            <button class="btn btn-submit" onclick="submitRequisition()"><i class="fa-solid fa-check"></i> Submit & Save</button>
        </div>

        <div class="add-item-controls">
            <b>Add Item:</b>
            <select id="itemSelect" style="padding:8px; border-radius:5px; border:1px solid #ccc;"><option value="">Select Item...</option></select>
            <input type="number" id="itemQty" placeholder="Qty" style="width:70px; padding:8px; border-radius:5px; border:1px solid #ccc;">
            <button class="btn" style="background:var(--success); width:auto; border-radius:20px;" onclick="addItemToSlip()">
                <i class="fa-solid fa-plus"></i> Add
            </button>
        </div>

        <div class="paper-slip" id="printableArea">
            <div class="ris-container">
                <div class="ris-header-italic">Appendix 63</div>
                <div class="ris-title">REQUISITION AND ISSUE SLIP</div>
                <table class="info-table">
                    <tr><td width="10%" class="label">Entity Name:</td><td width="40%" class="input-line">DepED RO I</td><td width="20%"></td><td width="10%" class="label">Fund Cluster:</td><td width="20%" class="input-line">01</td></tr>
                    <tr><td class="label">Division:</td><td class="input-line">ORD-PUBLIC AFFAIRS UNIT</td><td></td><td class="label" colspan="2" style="font-size:9px;">Responsibility Center Code:</td></tr>
                    <tr><td class="label">Office:</td><td class="input-line"></td><td></td><td class="label">RIS No.:</td><td class="input-line" id="risNo_1"></td></tr>
                </table>
                <table class="ris-table">
                    <thead>
                        <tr><th colspan="4">Requisition</th><th colspan="2">Stock Available?</th><th colspan="2">Issue</th></tr>
                        <tr><th width="8%">Stock No.</th><th width="8%">Unit</th><th width="34%">Description</th><th width="10%">Quantity</th><th width="5%">Yes</th><th width="5%">No</th><th width="10%">Quantity</th><th width="20%">Remarks</th></tr>
                    </thead>
                    <tbody id="risTableBody_1"></tbody>
                </table>
                <table class="footer-table">
                    <tr><td></td><td>Requested by:</td><td>Approved by:</td><td>Issued by:</td><td style="border-right:none;">Received by:</td></tr>
                    <tr><td>Signature:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                    <tr><td>Printed Name:</td><td><div class="sig-name">JOVANIE M. MAZON</div></td><td><div class="sig-name">CESAR S. BUCSIT</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Designation:</td><td><div class="sig-title">Admin Assistant I</div><div class="sig-title">ORD-PAU</div></td><td><div class="sig-title">Admin Officer V</div><div class="sig-title">ORD-PAU Caretaker</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Date:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                </table>
            </div>

            <div class="cut-line"></div>

            <div class="ris-container">
                <div class="ris-header-italic">Appendix 63</div>
                <div class="ris-title">REQUISITION AND ISSUE SLIP</div>
                <table class="info-table">
                    <tr><td width="10%" class="label">Entity Name:</td><td width="40%" class="input-line">DepED RO I</td><td width="20%"></td><td width="10%" class="label">Fund Cluster:</td><td width="20%" class="input-line">01</td></tr>
                    <tr><td class="label">Division:</td><td class="input-line">ORD-PUBLIC AFFAIRS UNIT</td><td></td><td class="label" colspan="2" style="font-size:9px;">Responsibility Center Code:</td></tr>
                    <tr><td class="label">Office:</td><td class="input-line"></td><td></td><td class="label">RIS No.:</td><td class="input-line" id="risNo_2"></td></tr>
                </table>
                <table class="ris-table">
                    <thead>
                        <tr><th colspan="4">Requisition</th><th colspan="2">Stock Available?</th><th colspan="2">Issue</th></tr>
                        <tr><th width="8%">Stock No.</th><th width="8%">Unit</th><th width="34%">Description</th><th width="10%">Quantity</th><th width="5%">Yes</th><th width="5%">No</th><th width="10%">Quantity</th><th width="20%">Remarks</th></tr>
                    </thead>
                    <tbody id="risTableBody_2"></tbody>
                </table>
                <table class="footer-table">
                    <tr><td></td><td>Requested by:</td><td>Approved by:</td><td>Issued by:</td><td style="border-right:none;">Received by:</td></tr>
                    <tr><td>Signature:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                    <tr><td>Printed Name:</td><td><div class="sig-name">JOVANIE M. MAZON</div></td><td><div class="sig-name">CESAR S. BUCSIT</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Designation:</td><td><div class="sig-title">Admin Assistant I</div><div class="sig-title">ORD-PAU</div></td><td><div class="sig-title">Admin Officer V</div><div class="sig-title">ORD-PAU Caretaker</div></td><td></td><td style="border-right:none;"></td></tr>
                    <tr><td>Date:</td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black;"></td><td style="border-bottom:1px solid black; border-right:none;"></td></tr>
                </table>
            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDxPnmXxfno19bkj9VHP1Do97PDg0lp04s",
            authDomain: "supplies-monitoring.firebaseapp.com",
            projectId: "supplies-monitoring",
            storageBucket: "supplies-monitoring.firebasestorage.app",
            messagingSenderId: "524755577094",
            appId: "1:524755577094:web:cd3c45819698c3380a1687",
            measurementId: "G-033SS1BHK1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let inventoryData = [], slipItems = [];

        window.onload = () => { loadInventory(); loadStats(); };

        function nav(id, btn) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }

        function loadInventory() {
            db.collection('inventory').onSnapshot(snap => {
                inventoryData = [];
                let totalStock = 0;
                const tbody = document.getElementById('inventoryTable');
                const select = document.getElementById('itemSelect');
                tbody.innerHTML = ''; select.innerHTML = '<option value="">Select Item...</option>';

                snap.forEach(doc => {
                    const d = doc.data(); d.id = doc.id;
                    inventoryData.push(d);
                    totalStock += d.currentQty;
                });
                
                inventoryData.sort((a,b) => a.itemName.localeCompare(b.itemName));

                inventoryData.forEach(item => {
                    // ADDED: Input and Button for Restocking
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.itemName}</td>
                            <td>${item.initialQty}</td>
                            <td>${item.unitPrice}</td>
                            <td style="font-weight:bold; color:var(--primary); font-size:1.1rem;">${item.currentQty}</td>
                            <td>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <input type="number" id="add-qty-${item.id}" class="h-8" style="width:70px; padding:5px; border:1px solid #ccc; border-radius:4px;" placeholder="0">
                                    <button onclick="addStock('${item.id}')" class="btn" style="background:var(--success); width:40px; padding:0; height:30px; min-width:unset; display:flex; align-items:center; justify-content:center;">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    select.innerHTML += `<option value="${item.id}">${item.itemName} (Stock: ${item.currentQty})</option>`;
                });
                document.getElementById('dash-total-items').innerText = totalStock;
                updateChart();
            });
        }
        
        // --- NEW FUNCTION: ADD STOCK ---
        async function addStock(id) {
            const input = document.getElementById(`add-qty-${id}`);
            const qty = Number(input.value);
            
            if(!qty || qty <= 0) return alert("Please enter a valid quantity greater than 0.");

            const item = inventoryData.find(i => i.id === id);
            
            // We update BOTH currentQty AND initialQty.
            // This ensures that if you hit "Reset" later, it resets to this NEW total amount.
            const newTotal = item.currentQty + qty;
            const newInitial = item.initialQty + qty;

            try {
                const batch = db.batch();
                const ref = db.collection('inventory').doc(id);
                
                batch.update(ref, { 
                    currentQty: newTotal,
                    initialQty: newInitial 
                });
                
                await batch.commit();
                alert(`Success! Added ${qty} units to ${item.itemName}.`);
                input.value = ''; // Clear input
            } catch(e) {
                console.error(e);
                alert("Error updating stock.");
            }
        }
        
        function loadStats() { db.collection('requisitions').onSnapshot(s => document.getElementById('dash-total-reqs').innerText = s.size); }

        function updateChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const data = inventoryData.slice(0, 15);
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.map(i=>i.itemName), datasets: [{ label:'Stock Level', data: data.map(i=>i.currentQty), backgroundColor:'#4a90e2', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function handleFileUpload(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const batch = db.batch();
                let count = 0;
                json.forEach(row => {
                    if(row.Name && row.Qty) {
                        count++;
                        batch.set(db.collection('inventory').doc(), {
                            itemName: String(row.Name), initialQty: Number(row.Qty), currentQty: Number(row.Qty), unitPrice: Number(row.Price||0), requestDates: []
                        });
                    }
                });
                batch.commit().then(()=>alert(count + ' Items Imported!'));
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function openModal() { 
            document.getElementById('reqModal').classList.add('open'); 
            document.getElementById('risNo_1').innerText = '';
            document.getElementById('risNo_2').innerText = '';
            slipItems=[]; renderSlip(); 
        }
        function closeModal() { document.getElementById('reqModal').classList.remove('open'); }

        function addItemToSlip() {
            const id = document.getElementById('itemSelect').value;
            const qty = Number(document.getElementById('itemQty').value);
            if(!id || qty<=0) return;
            const item = inventoryData.find(i=>i.id===id);
            if(qty > item.currentQty) return alert('Not enough stock!');
            slipItems.push({ ...item, reqQty: qty });
            renderSlip();
        }

        function renderSlip() {
            ['risTableBody_1', 'risTableBody_2'].forEach(tableId => {
                const tbody = document.getElementById(tableId);
                tbody.innerHTML = '';
                slipItems.forEach((item, i) => {
                    let cleanName = item.itemName.split(',')[0].split(';')[0].trim();
                    tbody.innerHTML += `
                        <tr>
                            <td></td> <td>pc</td>
                            <td style="text-align:left">${cleanName}</td>
                            <td>${item.reqQty}</td>
                            <td></td><td></td> <td></td><td></td> </tr>`;
                });
                for(let i=0; i < (10 - slipItems.length); i++) {
                    tbody.innerHTML += `<tr class="empty-row"><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
                }
            });
        }

        function exportToExcel() {
            let data = [];
            for(let k=0; k<2; k++) {
                data.push(["", "", "", "", "", "", "Appendix 63"]);
                data.push(["REQUISITION AND ISSUE SLIP"]);
                data.push(["Entity Name :", "", "DepED RO I", "", "", "", "Fund Cluster :", "01"]);
                data.push(["Division :", "ORD-PAU", "", "", "", "Responsibility Center Code :", ""]);
                data.push(["Office :", "", "", "", "", "RIS No. :", ""]);
                data.push(["Requisition", "", "", "", "Stock Available?", "", "Issue", ""]);
                data.push(["Stock No.", "Unit", "Description", "Quantity", "Yes", "No", "Quantity", "Remarks"]);
                slipItems.forEach((item, i) => {
                    let cleanName = item.itemName.split(',')[0].split(';')[0].trim();
                    data.push(["", "pc", cleanName, item.reqQty, "", "", "", ""]);
                });
                for(let i=0; i < (10 - slipItems.length); i++) data.push(["", "", "", "", "", "", "", ""]);
                data.push(["Purpose: Office Use"]);
                data.push(["", "Requested by:", "Approved by:", "Issued by:", "", "Received by:", ""]);
                data.push(["Signature:", "", "", "", "", "", ""]);
                data.push(["Printed Name:", "JOVANIE M. MAZON", "CESAR S. BUCSIT", "", "", "", ""]);
                data.push(["Designation:", "Admin Assistant I", "Admin Officer V", "", "", "", ""]);
                data.push(["Date:", "", "", "", "", "", ""]);
                data.push(["", "", "", "", "", "", "", ""]);
            }
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "RIS_Double");
            XLSX.writeFile(wb, "Requisition_Issue_Slip_Double.xlsx");
        }

        async function submitRequisition() {
            if(!slipItems.length) return alert("No items!");
            const batch = db.batch();
            const today = new Date().toISOString();
            batch.set(db.collection('requisitions').doc(), { date: today, items: slipItems });
            slipItems.forEach(item => {
                const ref = db.collection('inventory').doc(item.id);
                const current = inventoryData.find(i=>i.id===item.id).currentQty;
                batch.update(ref, { currentQty: current - item.reqQty, requestDates: firebase.firestore.FieldValue.arrayUnion(today) });
            });
            await batch.commit();
            alert("Inventory Updated!");
            closeModal();
        }

        async function resetInventory() {
            if(!confirm("⚠ WARNING: This will reset ALL items back to their Initial Quantity AND DELETE all Requisition history (setting the count to 0).\n\nAre you sure you want to proceed?")) return;
            const batch = db.batch();
            // 1. Reset Stock
            inventoryData.forEach(item => {
                const ref = db.collection('inventory').doc(item.id);
                batch.update(ref, { currentQty: item.initialQty, requestDates: [] });
            });
            // 2. Delete History
            const reqSnapshot = await db.collection('requisitions').get();
            reqSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            try {
                await batch.commit();
                alert("Success! System Reset.");
            } catch (error) {
                console.error("Error resetting:", error);
                alert("Error resetting. See console.");
            }
        }
    </script>
</body>
</html>
